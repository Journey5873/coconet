<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Chat Room Detail</title>
    <!-- 여기에 필요한 CSS 링크 등을 추가하세요 -->
</head>
<body>
<h2>Chat Room Detail</h2>

<!-- 채팅방 정보 표시 -->
<div>
    <p>Room UUID: <span th:text="${room.getRoomUUID()}"></span></p>
    <p>Room Name: <span th:text="${room.roomName}"></span></p>
    <!-- 추가적인 채팅방 정보 표시를 여기에 추가하세요 -->
</div>

<!-- 채팅 메시지 표시 -->
<div id="chatting">
    <h3>Chat Messages</h3>
    <div id="chatMessagesList">
    <!-- 여기에 채팅 메시지 목록을 루프로 돌며 표시하는 코드를 추가하세요 -->
    </div>
</div>

<!-- 메시지 입력 폼 -->
<div>
    <h3>Send a Message</h3>
    <input type="hidden" name="roomUUID" th:value="${roomUUID}" />
    <label for="message">Message:</label>
    <input type="text" id="message" name="message" required />
    <button id="send" type="button" onclick="sendChat()">Send</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.3.0/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
<script th:inline="javascript">
    var stompClient = null;
    var roomId = [[${room.roomUUID}]];
    var applicantUUID = [[${room.applicantUUID}]];
    var senderUUID = [[${sender}]];
    var chats = [[${chats}]]

    function connect() {
        // websocket stompClient
        var socket = new SockJS("/ws/chat");
        // stomp stompClient
        stompClient = Stomp.over(socket);
        stompClient.connect({}, function () {
            console.log("Connected!!")
            loadChat(chats)
            stompClient.subscribe('/queue/room/'+roomId, function (chatMsgResponseDto){
                showChat(JSON.parse(chatMsgResponseDto.body));
            });
        });
    }

    function disconnect() {
        if (stompClient !== null) {
            stompClient.disconnect();
        }
        console.log("Disconnected");
    }

    function sendChat() {
        var msg = document.getElementById('message').value;
        if (msg !== "") {
            stompClient.send("/app/message", {}, JSON.stringify({
                'roomUUID': roomId,
                'senderUUID': senderUUID,
                'message': msg
            }));
            document.getElementById("message").value = '';
        }
    }

    function loadChat(chats) {
        var chatMessagesList = document.getElementById("chatMessagesList");

        console.log(chats.length)
        if (chats != null) {
            for (chat in chats){
                var listItem = document.createElement("div");
                if (chats[chat].senderUUID == senderUUID) {
                    listItem.innerHTML = "<div class = 'chatting_own'><tr><td>" + chats[chat].message + "</td></tr></div>";
                } else {
                    listItem.innerHTML = "<div class = 'chatting'><tr><td>" + "[" + chats[chat].sender + "] " + chats[chat].message + "</td></tr></div>";
                }
                chatMessagesList.appendChild(listItem);
            }
        }
        chatMessagesList.scrollTop = chatMessagesList.scrollHeight;
    }

    function showChat(chatMsgResponseDto) {
        var chatMessagesList = document.getElementById("chatMessagesList");
        var listItem = document.createElement("div");

        if (chatMsgResponseDto.senderUUID == applicantUUID) {
            listItem.innerHTML = "<div class = 'chatting_own'><tr><td>" + chatMsgResponseDto.message + "</td></tr></div>";
        } else {
            listItem.innerHTML = "<div class = 'chatting'><tr><td>" + "[" + chatMsgResponseDto.sender + "] " + chatMsgResponseDto.message + "</td></tr></div>";
        }

        chatMessagesList.appendChild(listItem);
        chatMessagesList.scrollTop = chatMessagesList.scrollHeight;
    }
</script>
<script>
    //창 키면 바로 연결
    window.onload = function (){
        connect();
    }

    window.BeforeUnloadEvent = function (){
        disconnect();
    }
</script>
</body>
</html>
